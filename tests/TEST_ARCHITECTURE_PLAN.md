# æ¸¬è©¦æ¶æ§‹é‡æ§‹è¨ˆåŠƒ

## ğŸ“‹ **ç•¶å‰å•é¡Œåˆ†æ**

1. **æ¶æ§‹ä¸åŒ¹é…**: ç¾æœ‰æ¸¬è©¦åŸºæ–¼èˆŠçš„ main.py æ¶æ§‹ï¼Œéœ€è¦é©é…æ–°çš„å¤šå¹³å°æ¶æ§‹
2. **å°å…¥è·¯å¾‘éæ™‚**: æ¸¬è©¦ä¸­çš„å°å…¥è·¯å¾‘å’Œ mock å°è±¡éœ€è¦æ›´æ–°
3. **é…ç½®æ ¼å¼è®Šæ›´**: æ¸¬è©¦é…ç½®éœ€è¦å¾èˆŠæ ¼å¼é·ç§»åˆ°æ–°çš„å¤šå¹³å°æ ¼å¼
4. **æ¸¬è©¦è¦†è“‹ä¸è¶³**: ç¼ºå°‘å°æ–°å¹³å°æ¶æ§‹ç‰¹æ€§çš„æ¸¬è©¦

## ğŸ¯ **æ–°æ¸¬è©¦æ¶æ§‹è¨­è¨ˆ**

### **æ¸¬è©¦çµ„ç¹”çµæ§‹**

```
tests/
â”œâ”€â”€ conftest.py                 # å…¨åŸŸæ¸¬è©¦é…ç½®å’Œ fixtures
â”œâ”€â”€ test_main.py                # ä¸»æ‡‰ç”¨ç¨‹å¼æ¸¬è©¦ (æ–°å¢)
â”œâ”€â”€ unit/                       # å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_config.py          # é…ç½®ç³»çµ±æ¸¬è©¦
â”‚   â”œâ”€â”€ test_models/            # AI æ¨¡å‹æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_openai_model.py
â”‚   â”‚   â”œâ”€â”€ test_anthropic_model.py
â”‚   â”‚   â”œâ”€â”€ test_gemini_model.py
â”‚   â”‚   â”œâ”€â”€ test_ollama_model.py
â”‚   â”‚   â””â”€â”€ test_model_factory.py
â”‚   â”œâ”€â”€ test_platforms/         # å¹³å°è™•ç†å™¨æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_line_handler.py
â”‚   â”‚   â”œâ”€â”€ test_platform_factory.py
â”‚   â”‚   â””â”€â”€ test_platform_manager.py
â”‚   â”œâ”€â”€ test_services/          # æœå‹™å±¤æ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_core_chat_service.py
â”‚   â”‚   â”œâ”€â”€ test_response_formatter.py
â”‚   â”‚   â””â”€â”€ test_conversation_manager.py
â”‚   â”œâ”€â”€ test_database/          # è³‡æ–™åº«ç›¸é—œæ¸¬è©¦
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ test_database_orm.py
â”‚   â”‚   â””â”€â”€ test_migrations.py
â”‚   â””â”€â”€ test_utils/             # å·¥å…·å‡½æ•¸æ¸¬è©¦
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ test_text_processing.py
â”œâ”€â”€ integration/                # æ•´åˆæ¸¬è©¦
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_app_initialization.py  # æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–æ¸¬è©¦
â”‚   â”œâ”€â”€ test_platform_integration.py
â”‚   â”œâ”€â”€ test_chat_flow.py
â”‚   â””â”€â”€ test_database_integration.py
â”œâ”€â”€ api/                        # API ç«¯é»æ¸¬è©¦
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_health_endpoints.py   # å¥åº·æª¢æŸ¥å’ŒæŒ‡æ¨™
â”‚   â”œâ”€â”€ test_webhook_endpoints.py  # Webhook è™•ç†
â”‚   â””â”€â”€ test_legacy_compatibility.py # å‘å¾Œå…¼å®¹æ€§æ¸¬è©¦
â””â”€â”€ mocks/                      # Mock å’Œæ¸¬è©¦å·¥å…·
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ mock_config.py          # æ¨™æº–æ¸¬è©¦é…ç½®
    â”œâ”€â”€ mock_models.py          # AI æ¨¡å‹ mocks
    â”œâ”€â”€ mock_platforms.py       # å¹³å°è™•ç†å™¨ mocks
    â””â”€â”€ test_external_services.py
```

### **æ¸¬è©¦åˆ†é¡å’Œæ¨™è¨˜**

```python
@pytest.mark.unit          # å–®å…ƒæ¸¬è©¦
@pytest.mark.integration   # æ•´åˆæ¸¬è©¦
@pytest.mark.api          # API æ¸¬è©¦
@pytest.mark.slow         # æ…¢é€Ÿæ¸¬è©¦
@pytest.mark.database     # éœ€è¦è³‡æ–™åº«çš„æ¸¬è©¦
@pytest.mark.external     # éœ€è¦å¤–éƒ¨æœå‹™çš„æ¸¬è©¦
@pytest.mark.legacy       # èˆŠæ¶æ§‹å…¼å®¹æ€§æ¸¬è©¦
@pytest.mark.platform     # å¹³å°ç‰¹å®šæ¸¬è©¦
```

## ğŸ”„ **é·ç§»ç­–ç•¥**

### **éšæ®µ 1: åŸºç¤è¨­æ–½æ›´æ–°**
1. âœ… æ›´æ–° `conftest.py` - æ–°çš„é…ç½®æ ¼å¼å’Œ fixtures
2. âœ… å‰µå»º `test_main.py` - æ¸¬è©¦æ–°çš„çµ±ä¸€å…¥å£é»
3. âœ… æ›´æ–° mock é…ç½®åˆ°æ–°çš„å¤šå¹³å°æ ¼å¼

### **éšæ®µ 2: æ ¸å¿ƒçµ„ä»¶æ¸¬è©¦æ›´æ–°** 
1. ğŸ”„ é‡æ§‹å¹³å°ç›¸é—œæ¸¬è©¦ (`test_platforms/`)
2. ğŸ”„ æ›´æ–° AI æ¨¡å‹æ¸¬è©¦ (`test_models/`)
3. ğŸ”„ æ›´æ–°æœå‹™å±¤æ¸¬è©¦ (`test_services/`)

### **éšæ®µ 3: API å’Œæ•´åˆæ¸¬è©¦**
1. ğŸ”„ é‡å¯« API ç«¯é»æ¸¬è©¦
2. ğŸ”„ æ›´æ–°æ•´åˆæ¸¬è©¦
3. ğŸ”„ æ·»åŠ å‘å¾Œå…¼å®¹æ€§æ¸¬è©¦

### **éšæ®µ 4: é©—è­‰å’Œæ¸…ç†**
1. â³ é‹è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
2. â³ ä¿®å¾©å¤±æ•—çš„æ¸¬è©¦
3. â³ æ¸…ç†éæ™‚çš„æ¸¬è©¦æ–‡ä»¶

## ğŸ“ **é‡è¦æ›´æ–°é …ç›®**

### **é…ç½®æ ¼å¼æ›´æ–°**
```python
# èˆŠæ ¼å¼
config = {
    'line': {'channel_access_token': '...', 'channel_secret': '...'},
    'openai': {'api_key': '...', 'assistant_id': '...'}
}

# æ–°æ ¼å¼
config = {
    'platforms': {
        'line': {'enabled': True, 'channel_access_token': '...', 'channel_secret': '...'}
    },
    'llm': {'provider': 'openai'},
    'openai': {'api_key': '...', 'assistant_id': '...'}
}
```

### **å°å…¥è·¯å¾‘æ›´æ–°**
```python
# èˆŠå°å…¥
from main import app
from src.services.chat_service import ChatService

# æ–°å°å…¥  
from main import create_app, application
from src.services.core_chat_service import ChatService
```

### **æ¸¬è©¦å®¢æˆ¶ç«¯æ›´æ–°**
```python
# èˆŠæ–¹å¼
app.config['TESTING'] = True
client = app.test_client()

# æ–°æ–¹å¼
app = create_app()
app.config['TESTING'] = True
client = app.test_client()
```

## ğŸ¯ **æ¸¬è©¦é‡é»**

### **æ–°æ¶æ§‹ç‰¹æ€§æ¸¬è©¦**
1. **å¤šå¹³å°æ”¯æ´**: æ¸¬è©¦ LINEã€Discordã€Telegram å¹³å°è™•ç†
2. **ç’°å¢ƒè‡ªå‹•åˆ‡æ›**: æ¸¬è©¦é–‹ç™¼/ç”Ÿç”¢ç’°å¢ƒè‡ªå‹•æª¢æ¸¬
3. **çµ±ä¸€ webhook è™•ç†**: æ¸¬è©¦ `/webhooks/<platform>` è·¯ç”±
4. **å¹³å°å·¥å» æ¨¡å¼**: æ¸¬è©¦å¹³å°è™•ç†å™¨çš„å‰µå»ºå’Œè¨»å†Š
5. **å¥åº·æª¢æŸ¥å¢å¼·**: æ¸¬è©¦æ–°çš„å¥åº·æª¢æŸ¥æ ¼å¼å’Œå¹³å°ç‹€æ…‹

### **å‘å¾Œå…¼å®¹æ€§æ¸¬è©¦**
1. **èˆŠç«¯é»æ”¯æ´**: æ¸¬è©¦ `/callback` ç«¯é»ä»ç„¶å¯ç”¨
2. **WSGI æ‡‰ç”¨**: æ¸¬è©¦å¾ `wsgi.py` å’Œ `main.py` å°å…¥éƒ½æ­£å¸¸
3. **é…ç½®å…¼å®¹**: æ¸¬è©¦èˆŠé…ç½®æ ¼å¼çš„è™•ç†ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰

### **ç©©å®šæ€§æ¸¬è©¦**
1. **éŒ¯èª¤è™•ç†**: æ¸¬è©¦å„ç¨®éŒ¯èª¤æƒ…æ³ä¸‹çš„å›æ‡‰
2. **ä¸¦ç™¼è™•ç†**: æ¸¬è©¦å¤šå¹³å° webhook çš„ä¸¦ç™¼è™•ç†
3. **è³‡æºç®¡ç†**: æ¸¬è©¦è³‡æ–™åº«é€£æ¥æ± å’Œæ¨¡å‹å¯¦ä¾‹ç®¡ç†

## ğŸ“‹ **å¯¦ä½œæª¢æŸ¥æ¸…å–®**

- [ ] æ›´æ–° `conftest.py` é…ç½®æ ¼å¼
- [ ] å‰µå»º `test_main.py` ä¸»æ‡‰ç”¨ç¨‹å¼æ¸¬è©¦
- [ ] é‡æ§‹ API ç«¯é»æ¸¬è©¦
- [ ] æ›´æ–°å¹³å°è™•ç†å™¨æ¸¬è©¦
- [ ] æ›´æ–° AI æ¨¡å‹æ¸¬è©¦  
- [ ] æ›´æ–°æœå‹™å±¤æ¸¬è©¦
- [ ] æ·»åŠ æ–°æ¶æ§‹æ•´åˆæ¸¬è©¦
- [ ] å‰µå»ºå‘å¾Œå…¼å®¹æ€§æ¸¬è©¦
- [ ] é©—è­‰æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] æ¸…ç†éæ™‚æ¸¬è©¦æ–‡ä»¶